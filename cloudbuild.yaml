timeout: 7200s
options:
    env:
        - FIREBASE_PROJECT=$_FIREBASE_PROJECT
        - VIDEOSDB_CONFIG=$_VIDEOSDB_CONFIG
        - BRANCH_NAME=$BRANCH_NAME
steps:
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'echo $_DOCKER_PASSWORD | docker login --username eelis --password-stdin']

  - name: 'gcr.io/cloud-builders/docker'
    dir: "tests/end2end"
    args: ["compose", "-f", "docker-compose.cloudbuild.yml", "run", "--quiet-pull", "backend", "-m", "unittest"]

  - name: 'gcr.io/cloud-builders/docker'
    dir: "tests/end2end"
    args: ["compose", "-f", "docker-compose.cloudbuild.yml", "run", "--quiet-pull", "backend", "-m", "videosdb", "-c", "-e"]

  - name: 'gcr.io/cloud-builders/docker'
    dir: "tests/end2end"
    args: ["compose", "-f", "docker-compose.cloudbuild.yml", "run", "--quiet-pull", "frontend", "yarn", "generate"]

  - name: 'gcr.io/cloud-builders/docker'
    dir: "tests/end2end"
    args: ["compose", "-f", "docker-compose.cloudbuild.yml", "down"]

  - id: check-for-new-videos
    name: docker
    args:
      - run
      - --rm
      - -e
      - LOGLEVEL=$_LOGLEVEL
      - --env-file
      - common/env/$_VIDEOSDB_CONFIG.txt
      - gcr.io/worpdress-279321/backend-$BRANCH_NAME
      - -O
      - -m
      - videosdb
      - --check-for-new-videos


  - id: generate
    name: docker
    args:
      - run
      - --name
      - generate
      - --env-file
      - common/env/$_VIDEOSDB_CONFIG.txt
      - gcr.io/worpdress-279321/frontend-$BRANCH_NAME
      - yarn
      - generate

  - id: copy
    name: docker
    args:
      - cp
      - generate:/app/dist
      - frontend/


  - name: gcr.io/worpdress-279321/firebase
    env:
      - 'GOOGLE_APPLICATION_CREDENTIALS=backend/videosdb/keys/$_VIDEOSDB_CONFIG.json'
    args:
      - deploy
      - --project
      - $_FIREBASE_PROJECT
      - --only=hosting


timeout: 7200s
options:
    env:
        - BRANCH_NAME=$BRANCH_NAME
steps:
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'echo $_DOCKER_PASSWORD | docker login --username eelis --password-stdin']

  - name: 'gcr.io/cloud-builders/docker'
    dir: "tests/end2end"
    args: ["compose", "-f", "docker-compose.cloudbuild.yml", "pull", "-q"]

#   - name: 'gcr.io/cloud-builders/docker'
    # dir: "tests/end2end"
    # args: ["compose", "-f", "docker-compose.cloudbuild.yml", "run", "backend", "-m", "unittest"]

  - name: 'gcr.io/cloud-builders/docker'
    dir: "tests/end2end"
    args: ["compose", "-f", "docker-compose.cloudbuild.yml", "run", "backend", "-m", "videosdb", "-c", "-e"]

  - name: 'gcr.io/cloud-builders/docker'
    dir: "tests/end2end"
    args: ["compose", "-f", "docker-compose.cloudbuild.yml", "run", "frontend", "yarn", "generate"]

  - name: 'gcr.io/cloud-builders/docker'
    dir: "tests/end2end"
    args: ["compose", "-f", "docker-compose.cloudbuild.yml", "down"]
